services:
  drake:
    build:
      args:
        BASE_IMAGE: ${BASE_IMAGE}
        HOME: ${HOME}
        GID: ${GID}
        UID: ${UID}
        USERNAME: ${USER}
      context: ..
      dockerfile: docker/Dockerfile
    image: ${IMAGE_NAME}
    container_name: ${CONTAINER_NAME}
    hostname: ${HOSTNAME}
    platform: ${PLATFORM}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [compute, utility, graphics, display, gpu]
    runtime: nvidia
    environment:
      ARCH: ${ARCH}
      CONAN_USER_HOME: ${HOME}
      DISPLAY: ${DISPLAY}
      HOME: ${HOME}
      NVIDIA_VISIBLE_DEVICES: all
      PYTHONPATH: ${REPO_ROOT}
      VIRTUAL_ENV: ${REPO_ROOT}/.cvenv
      QT_XKB_CONFIG_ROOT: /usr/share/X11/xkb
    cap_add:
      - SYS_ADMIN  # for fuse mounting
      - SYS_PTRACE # for core dumps
    devices:
      - "/dev/fuse:/dev/fuse"
      - "/dev/dri/card0:/dev/dri/card0"
    ulimits:
      core: -1  # for unlimited
    security_opt:
      - apparmor:unconfined
      - seccomp:unconfined  # for gdb
    working_dir: ${REPO_ROOT}
    privileged: true
    tty: true
    volumes:
      # for graphics
      - /tmp/.X11-unix/:/tmp/.X11-unix/
      # docker out of docker
      - /var/run/docker.sock:/var/run/docker.sock
      # bazel cache
      - ${HOME}/.cache:${HOME}/.cache
      # mount repo
      - ..:${REPO_ROOT}
      - ${REPO_ROOT}/.venv/  # ignore host's venv
      - ${HOME}/.gitconfig:${HOME}/.gitconfig
      - ${HOME}/.netrc:${HOME}/.netrc
      - ${CONAN_USER_HOME}/.conan:${CONAN_USER_HOME}/.conan
    command: docker/mount_perms.sh $USER
    network_mode: host
